<html>
<head>
  <script src="js/fdb-all.min.js"></script>
  <script type="text/javascript" src="js/jquery-1.12.2.min.js"></script>
  <script type="text/javascript" src="js/bootstrap.min.js"></script>
  <link href="css/bootstrap.css" rel="stylesheet">
  <script>
    var fdb = new ForerunnerDB();
    var db = fdb.db("db");
    var studentCollection = db.collection("students")
    var scoreCollection = db.collection("score")
    var load_count = 0;
    function after_load(){
      load_count = load_count + 1;
      if(load_count == 2){
        for(var i=0;i<studentCollection.find().length;i++){
          $("tbody").append('<tr><td>'+studentCollection.find()[i].name+'</td><td>'+studentCollection.find()[i].age+'</td><td><a class="btn btn-default" data-id="'+i+'">Detail</a></td><tr>')
        }
        $("body").on("click", ".btn", function(){
          var score_id = $(this).attr("data-id")/1;
          var score_save = scoreCollection.find({id:score_id});
          var total = 0;
          for(var i=0;i<score_save.length;i++){
            var total = score_save[i].score + total;
          }
          alert("總分:" + total);
        })
        $("#button").click(function(){
          var stu_size = studentCollection.find().length;
          var new_id = studentCollection.find()[stu_size - 1].id + 1;
          studentCollection.insert(new student($('#name').val(),$("#age").val(),new_id))
          $("tbody").append('<tr><td>'+studentCollection.find()[new_id].name+'</td><td>'+studentCollection.find()[new_id].age+'</td><td><a class="btn btn-default" data-id="'+new_id+'">Detail</a></td><tr>')
          console.log(new_id);
          console.log($("#name").val());
          console.log($("#age").val());
          studentCollection.save();
        })
      }
      
    }

    studentCollection.load(after_load);
    scoreCollection.load(after_load);
    function student(name, age, id){
      this.name = name;
      this.age = age;
      this.id = id;
    }
    function score(id, subject, score){
      this.id = id;
      this.subject = subject;
      this.score = score;
    }
    function save_student(){
      studentCollection.insert(new student("Fiona", 12, 0));
      studentCollection.insert(new student("Jack", 13, 1));
      studentCollection.save();
      
      scoreCollection.insert(new score(0, "english", 90));
      scoreCollection.insert(new score(0, "chinese", 70));
      scoreCollection.insert(new score(0, "math", 80));
      scoreCollection.insert(new score(1, "english", 50));
      scoreCollection.insert(new score(1, "chinese", 60));
      scoreCollection.insert(new score(1, "math", 70));
      scoreCollection.save();
    }
  </script>
</head>
<body>
  <table class="table table-hover">
    <thead>
      <tr>
        <td>姓名</td>
        <td>年齡</td>
        <td></td>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
  <form>
  name:<br>
  <input type="text" id="name"><br>
  age:<br>
  <input type="text" id="age"><br>
  <input type="button" value="送出" id="button">
</form>
</body>
</html>
