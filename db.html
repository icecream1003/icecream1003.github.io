<html>
<head>
  <script src="js/fdb-all.min.js"></script>
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
  <script type="text/javascript" src="js/bootstrap.min.js"></script>
  <link href="css/bootstrap.css" rel="stylesheet">

</head>
<body>
  <div id="mymodal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Modal title</h4>
      </div>
      <div class="modal-body">
        <p>姓名</p>
        <input type="text" id="change_name">
        <p>年齡</p>
        <input type="text" id="change_age">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
  
  
  
  <table class="table table-hover">
    <thead>
      <tr>
        <td>姓名</td>
        <td>年齡</td>
        <td></td>
        <td></td>
      </tr>
    </thead>
    <tbody>
      <tr class="template">
        <td>name</td>
        <td>age</td>
        <td><a class="btn btn-default btn_detail" data-id="detail_id">Detail</a></td>
        <td><a class="btn btn-default btn_delete" data-id="delete_id">刪除</a></td>
        <td><a class="btn btn-default btn_change" data-id="change_id">修改</a></td>
      </tr>
    </tbody>
  </table>
  <form>
    name:<br>
    <input type="text" id="name"><br>
    age:<br>
    <input type="text" id="age"><br>
    <input type="button" value="送出" id="button">
  </form>
  <script>
    var fdb = new ForerunnerDB();
    var db = fdb.db("db");
    var studentCollection = db.collection("students")
    var scoreCollection = db.collection("score")
    $(".template").hide();

    
    function after_load(){
      load_count = load_count + 1;
      if(load_count == 2){ 
        for(var i=0;i<studentCollection.find().length;i++){
          var find = studentCollection.find()[i];
          var append_thing = $(".template").html().replace("name",find.name).replace("age",find.age).replace("detail.id",find.id).replace("delete_id",find.id).replace("change_id",find.id);
          $("tbody").append("<tr>"+append_thing+"</tr>");
        }
        $("body").on("click", ".btn_detail", function(){
          var score_id = $(this).attr("data-id")/1;
          var score_save = scoreCollection.find({id:score_id});
          var total = 0;
          for(var i=0;i<score_save.length;i++){
            var total = score_save[i].score + total;
          }
          alert("總分:" + total);
        })
        $("#button").click(function(){
          var stu_size = studentCollection.find().length;
          var new_id = studentCollection.find()[stu_size - 1].id + 1;
          if($("#name").val() == ""){
            alert("姓名欄要輸入");
          }else if($("#age").val() == ""){
            alert("年齡欄要輸入");
          }else{
            studentCollection.insert(new student($('#name').val(),$("#age").val(),new_id))
            var append_newthing = $(".template").html().replace("name",$('#name').val()).replace("age",$("#age").val()).replace("detail.id",new_id).replace("delete_id",new_id).replace("change_id",new_id);
            $("tbody").append("<tr>"+append_newthing+"</tr>")
            studentCollection.save();
            $("#name").val("");
            $("#age").val("");
          }
        })
        $("body").on("click",".btn_delete",function(){
          var ask_for_sure = confirm("Do you want to delete?")
          if(ask_for_sure == true){
            var delete_id = $(this).attr("data-id")/1;
            studentCollection.remove({id:delete_id});
            studentCollection.remove({id:delete_id});
            $(this).closest("tr").remove();
            studentCollection.save();
          }
        })
        $("body").on("click",".btn_change",function(){
          var change_id = $(this).attr("data-id")/1;
          var change_save = studentCollection.find({id:change_id});
          $("#mymodal").modal("show");
          $("#change_name").val(change_save[0].name);
          console.log(change_save[0].name);
          $("#change_name").val(change_save[0].age);
          console.log(change_save[0].name);
          console.log(change_save[0].age);
          console.log(change_save[0].id);
        })
      }
    }
    function student(name, age, id){
      this.name = name;
      this.age = age;
      this.id = id;
    }
    
    function score(id, subject, score){
      this.id = id;
      this.subject = subject;
      this.score = score;
    }
    
    function save_student(){
      studentCollection.insert(new student("Fiona", 12, 0));
      studentCollection.insert(new student("Jack", 13, 1));
      studentCollection.save();
      
      scoreCollection.insert(new score(0, "english", 90));
      scoreCollection.insert(new score(0, "chinese", 70));
      scoreCollection.insert(new score(0, "math", 80));
      scoreCollection.insert(new score(1, "english", 50));
      scoreCollection.insert(new score(1, "chinese", 60));
      scoreCollection.insert(new score(1, "math", 70));
      scoreCollection.save();
    }
        
    var load_count = 0;
    studentCollection.load(after_load);
    scoreCollection.load(after_load);
  </script>
</body>
</html>
